<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini GTA 3D Browser</title>
<style>
body { margin:0; overflow:hidden; background:#000; font-family:sans-serif; }
#hud { position:absolute; top:10px; left:10px; color:#fff; font-size:20px; text-shadow:2px 2px 5px black; }
#instructions { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#fff; font-size:24px; cursor:pointer; }
</style>
</head>
<body>
<div id="hud">Health: 100 | Score: 0</div>
<div id="instructions">Click to play and enable mouse control</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/PointerLockControls.js"></script>

<audio id="shootSound" src="https://actions.google.com/sounds/v1/weapons/medium_gun_shot.ogg"></audio>
<audio id="crashSound" src="https://actions.google.com/sounds/v1/impacts/crash.ogg"></audio>

<script>
let scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

let camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0, 5, 10);

let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Lighting
let light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(50,100,50);
scene.add(light);
scene.add(new THREE.AmbientLight(0x404040));

// Ground
let groundGeo = new THREE.PlaneGeometry(500,500);
let groundMat = new THREE.MeshStandardMaterial({color:0x555555});
let ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// Buildings
let buildings = [];
for(let i=0;i<20;i++){
    let geo = new THREE.BoxGeometry(Math.random()*10+10, Math.random()*30+10, Math.random()*10+10);
    let mat = new THREE.MeshStandardMaterial({color: Math.random()*0xffffff});
    let b = new THREE.Mesh(geo, mat);
    b.position.set((Math.random()-0.5)*400, geo.parameters.height/2, (Math.random()-0.5)*400);
    buildings.push(b);
    scene.add(b);
}

// Player
let player = {x:0, z:0, y:0.5, health:100, speed:0.5};
camera.position.set(player.x, player.y+2, player.z);

// PointerLockControls
let controls = new THREE.PointerLockControls(camera, document.body);
document.getElementById('instructions').addEventListener('click', ()=>{
    controls.lock();
    document.getElementById('instructions').style.display = 'none';
});

// Movement
let keys={};
document.addEventListener('keydown', e=> keys[e.key.toLowerCase()]=true);
document.addEventListener('keyup', e=> keys[e.key.toLowerCase()]=false);

// Enemies
let enemies = [];
function spawnEnemy(){
    let geo = new THREE.BoxGeometry(2,1,4);
    let mat = new THREE.MeshStandardMaterial({color:0x0000ff});
    let e = new THREE.Mesh(geo, mat);
    e.position.set((Math.random()-0.5)*400, 0.5, (Math.random()-0.5)*400);
    enemies.push(e);
    scene.add(e);
}
for(let i=0;i<5;i++) spawnEnemy();

// Bullets
let bullets=[];
const shootSound = document.getElementById('shootSound');
document.addEventListener('mousedown', ()=>{
    let bGeo = new THREE.SphereGeometry(0.2,8,8);
    let bMat = new THREE.MeshBasicMaterial({color:0xffff00});
    let bullet = new THREE.Mesh(bGeo,bMat);
    bullet.position.set(player.x, player.y+0.5, player.z);

    let dir = new THREE.Vector3(0,0,-1);
    dir.applyQuaternion(camera.quaternion);
    bullets.push({mesh:bullet, direction:dir});
    scene.add(bullet);
    shootSound.play();
});

// Collision detection
function collide(a,b){ 
    return Math.abs(a.x - b.position.x)<2 && Math.abs(a.z - b.position.z)<2; 
}

// Crash sound
const crashSound = document.getElementById('crashSound');

// Animate
function animate(){
    requestAnimationFrame(animate);

    // Player movement
    let dir = new THREE.Vector3();
    controls.getDirection(dir);
    dir.y=0; dir.normalize();

    if(keys['w']) { player.x += dir.x*player.speed; player.z += dir.z*player.speed; }
    if(keys['s']) { player.x -= dir.x*player.speed; player.z -= dir.z*player.speed; }
    if(keys['a']) { 
        let strafe = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), dir).normalize();
        player.x += strafe.x*player.speed; player.z += strafe.z*player.speed;
    }
    if(keys['d']) { 
        let strafe = new THREE.Vector3().crossVectors(dir, new THREE.Vector3(0,1,0)).normalize();
        player.x += strafe.x*player.speed; player.z += strafe.z*player.speed;
    }

    // Camera follow
    camera.position.set(player.x, player.y+2, player.z);

    // Bullets movement
    bullets.forEach((b,i)=>{
        b.mesh.position.addScaledVector(b.direction,1);
        if(b.mesh.position.length()>1000) scene.remove(b.mesh), bullets.splice(i,1);
    });

    // Enemy AI
    enemies.forEach((e)=>{
        let dx = player.x - e.position.x;
        let dz = player.z - e.position.z;
        let dist = Math.sqrt(dx*dx+dz*dz);
        e.position.x += (dx/dist)*0.05;
        e.position.z += (dz/dist)*0.05;

        if(collide(player, e)){
            player.health -= 0.5;
            crashSound.play();
            if(player.health<=0){
                alert("Game Over! Score: 0");
                location.reload();
            }
        }

        bullets.forEach((b,j)=>{
            if(collide({x:b.mesh.position.x,z:b.mesh.position.z},e)){
                scene.remove(b.mesh);
                bullets.splice(j,1);
                scene.remove(e);
                enemies.splice(enemies.indexOf(e),1);
            }
        });
    });

    // HUD
    document.getElementById('hud').innerText = `Health: ${Math.floor(player.health)} | Score: ${5-enemies.length}`;

    renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
